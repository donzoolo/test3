// Function to download a file
async function downloadFile(url, fileName) {
  try {
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error(`Failed to fetch ${url}: ${response.statusText}`);
    }
    const blob = await response.blob();

    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = fileName;

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    URL.revokeObjectURL(link.href);

    console.log(`Downloaded: ${fileName}`);
  } catch (error) {
    console.error(`Error downloading ${fileName}:`, error);
  }
}

async function capturePageScreenshot(targetUrl, textToWaitFor, screenshotName) {
  try {
    // Step 1: Navigate to the target URL
    console.log(`Navigating to ${targetUrl}...`);
    window.location.href = targetUrl;

    // Step 2: Wait for the page to load and desired text to appear
    console.log('Waiting for page load and target text...');
    await waitForTextToAppear(textToWaitFor, 15000); // 15-second timeout

    console.log('Text found. Taking screenshot...');

    // Step 3: Take a screenshot (DevTools-specific API)
    const screenshot = await new Promise((resolve, reject) => {
      try {
        chrome.runtime.sendMessage(
          { action: 'captureVisibleTab' },
          result => resolve(result)
        );
      } catch (error) {
        reject(error);
      }
    });

    // Save the screenshot
    const link = document.createElement('a');
    link.href = screenshot;
    link.download = screenshotName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    console.log(`Screenshot saved as: ${screenshotName}`);
  } catch (error) {
    console.error('Error capturing screenshot:', error);
  }
}

// Helper function to wait for text to appear on the page
function waitForTextToAppear(text, timeout = 10000) {
  return new Promise((resolve, reject) => {
    const intervalTime = 100; // Check every 100ms
    const startTime = Date.now();

    const checkForText = () => {
      const bodyText = document.body.innerText || document.body.textContent;
      if (bodyText.includes(text)) {
        resolve();
      } else if (Date.now() - startTime > timeout) {
        reject(new Error(`Timeout: Text "${text}" not found on the page.`));
      } else {
        setTimeout(checkForText, intervalTime);
      }
    };

    checkForText();
  });
}
const targetUrl = 'https://example.com/page-to-capture'; // URL to navigate to
const textToWaitFor = 'Statistics'; // Text to wait for on the page
const screenshotName = 'page-screenshot.png'; // Name for the screenshot file

capturePageScreenshot(targetUrl, textToWaitFor, screenshotName);


// Example Usage:
// Download files
const filesToDownload = [
  { url: 'https://example.com/file1.zip', name: 'test-123.zip' },
  { url: 'https://example.com/file2.pdf', name: 'example-file.pdf' },
];
filesToDownload.forEach(file => downloadFile(file.url, file.name));

// Capture a screenshot
capturePageScreenshot(
  'a.example-link', // Selector for the link to click
  () => [...document.querySelectorAll('p.dashboard-title')].find(el => el.textContent.trim() === 'Statistics'), // Function to locate the element
  'page-screenshot.png' // Desired screenshot file name
);