// Function to download a file
async function downloadFile(url, fileName) {
  try {
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error(`Failed to fetch ${url}: ${response.statusText}`);
    }
    const blob = await response.blob();

    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = fileName;

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    URL.revokeObjectURL(link.href);

    console.log(`Downloaded: ${fileName}`);
  } catch (error) {
    console.error(`Error downloading ${fileName}:`, error);
  }
}

async function capturePageScreenshot(linkSelector, elementLocator, screenshotName) {
  try {
    // Step 1: Find and click the link
    const linkElement = document.querySelector(linkSelector);
    if (!linkElement) {
      throw new Error(`Link not found with selector: ${linkSelector}`);
    }

    console.log('Clicking link...');
    linkElement.click();

    // Step 2: Wait for navigation to complete
    console.log('Waiting for page to load...');
    await waitForPageNavigation();

    // Step 3: Locate and scroll to the specified element
    console.log('Locating target element...');
    const targetElement =
      typeof elementLocator === 'function'
        ? elementLocator()
        : document.querySelector(elementLocator);

    if (!targetElement) {
      throw new Error('Target element not found.');
    }

    console.log('Scrolling to element...');
    targetElement.scrollIntoView({ behavior: 'smooth' });

    // Wait briefly to ensure the scroll is completed
    await new Promise(resolve => setTimeout(resolve, 1000));

    // Step 4: Take a screenshot (DevTools-specific API)
    console.log('Taking screenshot...');
    const screenshot = await new Promise((resolve, reject) => {
      try {
        chrome.runtime.sendMessage(
          { action: 'captureVisibleTab' },
          result => resolve(result)
        );
      } catch (error) {
        reject(error);
      }
    });

    // Save the screenshot
    const link = document.createElement('a');
    link.href = screenshot;
    link.download = screenshotName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    console.log(`Screenshot saved as: ${screenshotName}`);
  } catch (error) {
    console.error('Error capturing screenshot:', error);
  }
}

// Helper function to wait for page navigation to complete
function waitForPageNavigation() {
  return new Promise(resolve => {
    const checkReadyState = () => {
      if (document.readyState === 'complete') {
        resolve();
      } else {
        setTimeout(checkReadyState, 100); // Retry until ready
      }
    };
    checkReadyState();
  });
}

// Example Usage:
// Download files
const filesToDownload = [
  { url: 'https://example.com/file1.zip', name: 'test-123.zip' },
  { url: 'https://example.com/file2.pdf', name: 'example-file.pdf' },
];
filesToDownload.forEach(file => downloadFile(file.url, file.name));

// Capture a screenshot
capturePageScreenshot(
  'a.example-link',                // Selector for the link to click
  element => [...document.querySelectorAll('p.dashboard-title')].find(el => el.textContent.trim() === 'Statistics'), // Function to dynamically locate the element
  'page-screenshot.png'            // Name of the screenshot file
);