#!/bin/bash

BIG="BQWERTYU,BQWERTYI"
MEDIUM="MQWERTYU,MQWERTYI"
SMALL="SQWERTYU,SQWERTYI"

awk -v BIG="$BIG" -v MEDIUM="$MEDIUM" -v SMALL="$SMALL" '
BEGIN {
    split(BIG, big_bics, ",");
    for (i in big_bics) bic_category[big_bics[i]] = "BIG";
    split(MEDIUM, medium_bics, ",");
    for (i in medium_bics) bic_category[medium_bics[i]] = "MEDIUM";
    split(SMALL, small_bics, ",");
    for (i in small_bics) bic_category[small_bics[i]] = "SMALL";
    
    num_cats = 3;
    cat_order[1] = "BIG";
    cat_order[2] = "MEDIUM";
    cat_order[3] = "SMALL";
}

{
    if ($0 ~ /Sending BIC:/) {
        # Process Sending lines (unchanged)
        if (match($0, /Sending BIC: ([A-Z0-9]+).* - ([A-Z0-9]+)/, m)) {
            bic = m[1];
            msg_type = m[2];
            cat = bic_category[bic];
            if (cat) {
                counts[msg_type][cat]++;
                msg_types[msg_type] = 1;
            }
        }
    }
    else if ($0 ~ /BATCH BIC:/) {
        # Process both "BATCH BIC" and "FIN BATCH BIC" lines
        if (match($0, /BIC: ([A-Z0-9]+),/, m)) {
            bic = m[1];
            cat = bic_category[bic];
            if (cat) {
                # Extract everything after BIC
                rest = substr($0, RSTART + RLENGTH);
                # Split into components like "MT103: 6"
                n = split(rest, parts, /,[[:space:]]*/);
                for (i = 1; i <= n; i++) {
                    if (match(parts[i], /^[[:space:]]*([A-Z0-9]+):[[:space:]]*([0-9]+)/, m_part)) {
                        msg_type = m_part[1];
                        count = m_part[2];
                        counts[msg_type][cat] += count;
                        msg_types[msg_type] = 1;
                    }
                }
            }
        }
    }
}

END {
    # (Remaining code unchanged - same sorting and output logic)
    # ... [rest of the END block]
}' "$1"