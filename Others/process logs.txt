#!/bin/bash

BIG="BQWERTYU,BQWERTYI"
MEDIUM="MQWERTYU,MQWERTYI"
SMALL="SQWERTYU,SQWERTYI"

awk -v BIG="$BIG" -v MEDIUM="$MEDIUM" -v SMALL="$SMALL" '
BEGIN {
    split(BIG, big_bics, ","); 
    for (i in big_bics) bic_category[big_bics[i]] = "BIG";
    split(MEDIUM, medium_bics, ","); 
    for (i in medium_bics) bic_category[medium_bics[i]] = "MEDIUM";
    split(SMALL, small_bics, ","); 
    for (i in small_bics) bic_category[small_bics[i]] = "SMALL";
    
    num_cats = 3;
    cat_order[1] = "BIG";
    cat_order[2] = "MEDIUM";
    cat_order[3] = "SMALL";
}

{
    if ($0 ~ /Sending BIC:/) {
        if (match($0, /Sending BIC: ([A-Z0-9]+).* - ([A-Z0-9]+)$/, m)) {
            bic = m[1];
            msg_type = m[2];
            cat = bic_category[bic];
            if (cat) {
                counts[msg_type][cat]++;
                msg_types[msg_type] = 1;
            }
        }
    }
    else if ($0 ~ /BATCH BIC:/) {
        if (match($0, /BIC: ([A-Z0-9]+),/, m)) {
            bic = m[1];
            cat = bic_category[bic];
            if (cat) {
                rest = substr($0, RSTART + RLENGTH);
                while (match(rest, /([A-Z0-9]+): *([0-9]+)/, m_part)) {
                    msg_type = m_part[1];
                    count = m_part[2];
                    counts[msg_type][cat] += count;
                    msg_types[msg_type] = 1;
                    rest = substr(rest, RSTART + RLENGTH);
                }
            }
        }
    }
}

END {
    num_msg = asorti(msg_types, sorted_msg);
    
    # Print header with SUM column
    printf "%-20s", "";
    for (c = 1; c <= num_cats; c++) printf "%-10s", cat_order[c];
    printf "%-10s\n", "SUM";
    
    # Initialize totals
    delete col_total;  # Column totals
    col_total["BIG"] = col_total["MEDIUM"] = col_total["SMALL"] = 0;
    grand_total = 0;
    
    # Print message rows with row totals
    for (i = 1; i <= num_msg; i++) {
        msg = sorted_msg[i];
        printf "%-20s", msg;
        row_total = 0;
        for (c = 1; c <= num_cats; c++) {
            cat = cat_order[c];
            count = (counts[msg][cat] ? counts[msg][cat] : 0);
            printf "%-10d", count;
            col_total[cat] += count;
            row_total += count;
        }
        printf "%-10d\n", row_total;
        grand_total += row_total;
    }
    
    # Print column totals row
    printf "%-20s", "SUM";
    sum_cols = 0;
    for (c = 1; c <= num_cats; c++) {
        cat = cat_order[c];
        printf "%-10d", col_total[cat];
        sum_cols += col_total[cat];
    }
    printf "%-10d\n", sum_cols);
}' "$1"