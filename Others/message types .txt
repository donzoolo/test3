#!/bin/bash

logfile="logfile.log"

# Normalize types for consistency
normalize_type() {
    local type="$1"
    type=$(echo "$type" | tr -d ' ') # Remove spaces
    type=$(echo "$type" | sed 's/^004$/PACS004/')
    type=$(echo "$type" | sed 's/^008$/PACS008/')
    type=$(echo "$type" | sed 's/^009$/PACS009/')
    echo "$type"
}

# Process 1st type of logs
echo "Counts for 1st type of logs:"
counts1=$(grep 'Sending BIC' "$logfile" | awk '
{
    if (match($0, /(MT 103|MT 202 COV|MT 202|PACS 004|PACS 008|PACS 009)/, arr)) {
        gsub(" ", "", arr[1]) # Remove spaces to normalize the log type names
        count[arr[1]]++
    }
}
END {
    for (type in count) {
        print type ": " count[type]
    }
}')
echo "$counts1"

# Process 2nd type of logs
echo "Counts for 2nd type of logs:"
counts2=$(grep -E 'BATCH BIC|FIN BATCH BIC' "$logfile" | awk '
{
    if (match($0, /(004: [0-9]+|008: [0-9]+|009: [0-9]+|MT103: [0-9]+|MT202: [0-9]+|MT202COV: [0-9]+)/)) {
        split($0, fields, ", ")
        for (i in fields) {
            if (match(fields[i], /(004|008|009|MT103|MT202|MT202COV): [0-9]+/)) {
                split(fields[i], pair, ": ")
                type = pair[1]
                value = pair[2]
                type=$(echo "$type" | sed "s/004/PACS004/;s/008/PACS008/;s/009/PACS009/")
                count[type] += value
                print "Processed: " type " = " count[type] # Debug output
            }
        }
    }
}
END {
    for (type in count) {
        print type ": " count[type]
    }
}')
echo "$counts2"

# Function to sum counts from both logs
sum_counts() {
    local type="$1"
    local normalized_type=$(normalize_type "$type")
    local count1=$(echo "$counts1" | grep "$normalized_type" | awk -F': ' '{print $2}')
    local count2=$(echo "$counts2" | grep "$normalized_type" | awk -F': ' '{print $2}')
    
    # Handle empty values
    count1=${count1:-0}
    count2=${count2:-0}

    # Ensure count1 and count2 are numeric
    if ! [[ "$count1" =~ ^[0-9]+$ ]]; then
        count1=0
    fi
    if ! [[ "$count2" =~ ^[0-9]+$ ]]; then
        count2=0
    fi

    echo "Summing for $normalized_type: $count1 + $count2 = $((count1 + count2))" >&2 # Debug output
    echo $((count1 + count2))
}

# Calculate Total Count
total_count=0
for type in "MT103" "MT202" "MT202COV" "PACS004" "PACS008" "PACS009"; do
    count=$(sum_counts "$type")
    total_count=$((total_count + count))
done

# Calculate Count of MT
mt_count=0
for type in "MT103" "MT202" "MT202COV"; do
    count=$(sum_counts "$type")
    mt_count=$((mt_count + count))
done

# Calculate Count of ISO
iso_count=0
for type in "PACS004" "PACS008" "PACS009"; do
    count=$(sum_counts "$type")
    iso_count=$((iso_count + count))
done

# Print Summary
echo "Summary:"
echo "Total count: $total_count"
echo "Count of MT: $mt_count"
echo "Count of ISO: $iso_count"
